<!DOCTYPE html>
<html>

<head>
    <title>Web Terminal</title>
    <!-- Import xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }

        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        /* Terminal Container */
        #terminal-container {
            z-index: 10;
            width: 80%;
            height: 80%;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border: 2px solid #0f0;
            box-shadow: 0 0 20px #005500, inset 0 0 10px #002200;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 20, 0, 0.9);
            color: #0f0;
            padding: 8px 15px;
            border-bottom: 1px solid #0f0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
            user-select: none;
        }

        .xterm-viewport {
            overflow-y: auto;
        }

        /* Floating Settings Button */
        #settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #0f0;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 10px #0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #settings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px #0f0;
        }

        #settings-btn svg {
            width: 24px;
            height: 24px;
            fill: #000;
        }

        /* Modal */
        #settings-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 450px;
            max-height: 85vh;
            background: rgba(10, 10, 10, 0.95);
            border: 2px solid #0f0;
            border-radius: 12px;
            color: #0f0;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.2);
            z-index: 200;
            backdrop-filter: blur(10px);
            flex-direction: column;
            overflow: hidden;
        }

        #settings-modal.active {
            display: flex;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 15px;
            color: inherit;
            opacity: 0.6;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            opacity: 1;
            border-bottom: 2px solid currentColor;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content::-webkit-scrollbar {
            width: 6px;
        }

        .tab-content::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Forms */
        .setting-group {
            margin-bottom: 18px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        input[type="color"] {
            width: 100%;
            height: 35px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: #000;
            cursor: pointer;
            border-radius: 4px;
            padding: 2px;
        }

        input[type="number"],
        select {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: inherit;
            padding: 10px;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
            font-size: 13px;
        }

        select option {
            background: #000;
            color: #fff;
        }

        input[type="range"] {
            width: 100%;
            accent-color: currentColor;
            cursor: pointer;
            height: 8px;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 4px;
            appearance: none;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 22px;
            height: 22px;
            background: currentColor;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.6);
            transition: transform 0.1s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 4px;
        }

        .checkbox-group label {
            margin-bottom: 0;
        }

        .checkbox-group input {
            width: auto;
            transform: scale(1.2);
        }
    </style>
</head>

<body>

    <canvas id="bg-canvas"></canvas>

    <div id="terminal-container">
        <div class="header">
            <span>System Access: Authorized</span>
            <span>Online</span>
        </div>
        <div id="terminal"></div>
    </div>

    <button id="settings-btn" title="Customize UI">
        <svg viewBox="0 0 24 24">
            <path
                d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
        </svg>
    </button>

    <div id="settings-modal">

        <div class="tabs">
            <button class="tab-btn active" data-tab="tab-visual">Visuals</button>
            <button class="tab-btn" data-tab="tab-effects">Effects</button>
            <button class="tab-btn" data-tab="tab-audio">Audio</button>
            <button class="tab-btn" data-tab="tab-type">Typography</button>
        </div>

        <div class="tab-content active" id="tab-visual">
            <div class="setting-group">
                <label>Preset Themes</label>
                <select id="opt-preset">
                    <option value="custom">Custom</option>
                    <option value="matrix">Matrix Hacker</option>
                    <option value="cyber">Cyberpunk Neon</option>
                    <option value="bubblegum">Bubblegum Pop</option>
                    <option value="ice">Arctic Ice</option>
                    <option value="midnight">Midnight Pro</option>
                    <option value="gold">Luxury Gold</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Text Color</label>
                <input type="color" id="opt-fg" value="#00ff00">
            </div>
            <div class="setting-group">
                <label>Background Color</label>
                <input type="color" id="opt-bg" value="#000000">
            </div>
            <div class="setting-group">
                <label>Accent Color</label>
                <input type="color" id="opt-accent" value="#00ff00">
            </div>
            <div class="setting-group">
                <label>Window Transparency</label>
                <input type="range" id="opt-opacity" min="0" max="1" step="0.05" value="0.9">
            </div>
            <div class="setting-group">
                <label>Glow Intensity</label>
                <input type="range" id="opt-glow" min="0" max="50" value="20">
            </div>
            <div class="setting-group">
                <label>Border Radius</label>
                <input type="range" id="opt-radius" min="0" max="30" value="12">
            </div>
        </div>

        <div class="tab-content" id="tab-effects">
            <div class="setting-group">
                <label>Background Effect</label>
                <select id="opt-bg-effect">
                    <option value="none">None</option>
                    <option value="matrix">Matrix Rain</option>
                    <option value="snow">Heavy Snow</option>
                    <option value="bubbles">Rising Bubbles</option>
                    <option value="stars">Starfield Warp</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Effect Speed</label>
                <input type="range" id="opt-effect-speed" min="1" max="100" value="50">
            </div>
            <div class="setting-group">
                <label>Effect Density</label>
                <input type="range" id="opt-effect-density" min="10" max="200" value="100">
            </div>
            <br>
            <div class="setting-group checkbox-group">
                <label>CRT Flicker Overlay</label>
                <input type="checkbox" id="opt-flicker">
            </div>
        </div>

        <div class="tab-content" id="tab-audio">
            <div class="setting-group">
                <label>Keyboard Sound Profile</label>
                <select id="opt-sound">
                    <option value="none">Silent</option>
                    <option value="mech">Mechanical Switch (Thocky)</option>
                    <option value="typewriter">Old Typewriter</option>
                    <option value="beep">Retro Beep</option>
                    <option value="bubble">Bubble Pop</option>
                    <option value="scifi">Sci-Fi Blip</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Volume</label>
                <input type="range" id="opt-volume" min="0" max="1" step="0.05" value="0.5">
            </div>
        </div>

        <div class="tab-content" id="tab-type">
            <div class="setting-group">
                <label>Font Family</label>
                <select id="opt-font">
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="'Fira Code', monospace">Fira Code</option>
                    <option value="'Roboto Mono', monospace">Roboto Mono</option>
                    <option value="'Press Start 2P', cursive">Pixel Art</option>
                    <option value="'Consolas', monospace">Consolas</option>
                    <option value="'Arial', sans-serif">Arial</option>
                </select>
            </div>
            <div class="setting-group">
                <label>Font Size (px)</label>
                <input type="number" id="opt-size" value="16" min="8" max="48">
            </div>
            <div class="setting-group">
                <label>Letter Spacing</label>
                <input type="range" id="opt-spacing" min="-2" max="10" step="0.5" value="0">
            </div>
            <div class="setting-group">
                <label>Cursor Style</label>
                <select id="opt-cursor-style">
                    <option value="block">Block</option>
                    <option value="underline">Underline</option>
                    <option value="bar">Bar</option>
                </select>
            </div>
            <br>
            <div class="setting-group checkbox-group">
                <label>Cursor Blinking</label>
                <input type="checkbox" id="opt-blink" checked>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Enhanced Sound Manager ---
        class SoundManager {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.volume = 0.5;
                this.type = 'none';
            }

            setVolume(v) { this.volume = v; }
            setType(t) { this.type = t; }

            resume() {
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume().catch(() => { });
                }
            }

            play() {
                this.resume();
                if (this.type === 'none') return;

                const playbackRate = 0.9 + Math.random() * 0.2; // Humanize

                switch (this.type) {
                    case 'beep':
                        this.playOsc(800 * playbackRate, 'square', 0.05, 0.05);
                        break;
                    case 'scifi':
                        this.playOsc(1200 * playbackRate, 'sine', 0.1, 0.1, 400);
                        break;
                    case 'mech':
                        // THOCK: Triangle osc for body + Highpass noise for click
                        this.playOsc(150, 'triangle', 0.3, 0.05);
                        this.playNoise(0.015, 2000, 'highpass', 0.25);
                        break;
                    case 'typewriter':
                        this.playNoise(0.04, 800, 'lowpass', 0.6);
                        this.playNoise(0.08, 200, 'lowpass', 0.4); // Thud
                        break;
                    case 'bubble':
                        this.playOsc(300 * playbackRate, 'sine', 0.2, 0.08, 600, 'linear');
                        break;
                }
            }

            playOsc(freq, type, gainVal, dur, rampto, rampType = 'exp') {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.frequency.setValueAtTime(freq, t);
                if (rampto) {
                    if (rampType === 'exp') osc.frequency.exponentialRampToValueAtTime(rampto, t + dur);
                    else osc.frequency.linearRampToValueAtTime(rampto, t + dur);
                }

                osc.type = type;
                gain.connect(this.ctx.destination);
                osc.connect(gain);

                gain.gain.setValueAtTime(this.volume * gainVal, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + dur);

                osc.start(t);
                osc.stop(t + dur + 0.05);
            }

            playNoise(duration, filterFreq, filterType, mix = 0.5) {
                try {
                    const bufferSize = this.ctx.sampleRate * duration;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

                    const noise = this.ctx.createBufferSource();
                    noise.buffer = buffer;
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = filterType;
                    filter.frequency.value = filterFreq;
                    const gain = this.ctx.createGain();
                    gain.gain.value = this.volume * mix;

                    noise.connect(filter);
                    filter.connect(gain);
                    gain.connect(this.ctx.destination);
                    noise.start();
                } catch (e) { }
            }
        }

        // --- 2. Enhanced Effects Manager ---
        class EffectsManager {
            constructor() {
                this.canvas = document.getElementById('bg-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.effect = 'none';
                this.speed = 50;
                this.density = 100;
                this.particles = [];
                this.animationId = null;
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            setEffect(name) {
                if (this.effect === name) return;
                this.effect = name;
                this.initEffect();
                this.start();
            }

            setParams(speed, density) {
                const s = parseInt(speed);
                const d = parseInt(density);
                if (this.speed === s && this.density === d) return;
                this.speed = s;
                this.density = d;
                if (this.effect !== 'none') this.initEffect();
            }

            initEffect() {
                this.particles = [];
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                const count = Math.floor((this.density / 100) * 150);

                if (this.effect === 'matrix') {
                    const columns = Math.floor(this.canvas.width / 20);
                    for (let i = 0; i < columns; i++) {
                        this.particles.push({
                            x: i * 20,
                            y: Math.random() * -this.canvas.height,
                            v: (Math.random() * 2 + 1) * (this.speed / 50),
                            chars: "01"
                        });
                    }
                } else if (['snow', 'stars', 'bubbles'].includes(this.effect)) {
                    for (let i = 0; i < count; i++) this.particles.push(this.createParticle());
                }
            }

            createParticle() {
                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    size: Math.random() * 3 + 1,
                    v: (Math.random() * 2 + 0.5) * (this.speed / 50),
                    alpha: Math.random(),
                    wobble: Math.random() * Math.PI * 2
                };
            }

            animate() {
                if (!this.ctx) return;
                if (this.effect === 'none') {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    return;
                }

                if (this.effect === 'matrix') {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; // Trail effect
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                    // Use Neon Green always for Matrix
                    this.ctx.fillStyle = '#0f0';
                    this.ctx.font = '14px monospace';

                    this.particles.forEach(p => {
                        this.ctx.fillText(Math.random() > 0.5 ? '1' : '0', p.x, p.y);
                        p.y += p.v * 5;
                        if (p.y > this.canvas.height && Math.random() > 0.95) p.y = 0;
                    });
                }
                else if (this.effect === 'stars') {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Warp trail
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.fillStyle = '#fff';

                    const cx = this.canvas.width / 2;
                    const cy = this.canvas.height / 2;

                    this.particles.forEach(p => {
                        const dx = p.x - cx;
                        const dy = p.y - cy;
                        p.x += dx * (0.01 + p.v * 0.01);
                        p.y += dy * (0.01 + p.v * 0.01);
                        p.size += 0.02 * p.v;

                        this.ctx.fillRect(p.x, p.y, p.size, p.size);

                        if (p.x < 0 || p.x > this.canvas.width || p.y < 0 || p.y > this.canvas.height) {
                            p.x = Math.random() * 20 - 10 + cx;
                            p.y = Math.random() * 20 - 10 + cy;
                            p.size = 1;
                        }
                    });
                }
                else {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.particles.forEach(p => {
                        if (this.effect === 'snow') {
                            this.ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
                            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); this.ctx.fill();
                            p.y += p.v;
                            p.wobble += 0.03;
                            p.x += Math.sin(p.wobble) * 0.5;
                            if (p.y > this.canvas.height) { p.y = -10; p.x = Math.random() * this.canvas.width; }
                        } else if (this.effect === 'bubbles') {
                            this.ctx.fillStyle = `rgba(255, 150, 200, ${p.alpha * 0.3})`;
                            this.ctx.strokeStyle = `rgba(255, 255, 255, ${p.alpha * 0.6})`;
                            this.ctx.lineWidth = 1;
                            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size * 2, 0, Math.PI * 2); this.ctx.fill(); this.ctx.stroke();
                            p.y -= p.v;
                            p.wobble += 0.02;
                            p.x += Math.sin(p.wobble) * 1;
                            if (p.y < -20) { p.y = this.canvas.height + 20; p.x = Math.random() * this.canvas.width; }
                        }
                    });
                }

                this.animationId = requestAnimationFrame(() => this.animate());
            }

            start() {
                if (this.animationId) cancelAnimationFrame(this.animationId);
                this.animate();
            }
        }

        // --- 3. App Initialization ---
        // Setup Terminal
        const term = new Terminal({
            cursorBlink: true,
            allowTransparency: true, // Key for see-through
            fontFamily: '"Fira Code", monospace',
            fontSize: 16,
            theme: { background: 'transparent' }
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));

        // Auto Fit
        const fitTerm = () => {
            const container = document.getElementById('terminal-container');
            // Calculate available space:
            // Height: clientHeight - 40px (padding) - 35px (header margin) - 15px (extra buffer)
            const h = container.clientHeight - 90;
            // Width: clientWidth - 40px (padding)
            const w = container.clientWidth - 40;

            document.getElementById('terminal').style.height = h + "px";
            document.getElementById('terminal').style.width = w + "px";
            fitAddon.fit();
        };
        document.getElementById('terminal').style.marginTop = "35px"; // Push down for header

        window.addEventListener('resize', fitTerm);
        // Delay fit slightly to ensure DOM is ready
        setTimeout(fitTerm, 100);

        // Managers
        const soundMgr = new SoundManager();
        const effectMgr = new EffectsManager();

        // WebSocket
        const socket = new WebSocket("ws://" + location.host + "/ws");
        socket.onmessage = (e) => term.write(e.data);

        // Input Handling
        term.onData(data => {
            soundMgr.play();
            socket.send(data);
        });

        // Click to focus (Important for receiving keystrokes like Ctrl+C)
        document.getElementById('terminal-container').addEventListener('click', () => {
            term.focus();
            // Also resume audio context on interaction
            soundMgr.resume();
        });

        // --- 4. Customization Logic ---
        const ui = {
            modal: document.getElementById('settings-modal'),
            btn: document.getElementById('settings-btn'),

            tabs: document.querySelectorAll('.tab-btn'),
            contents: document.querySelectorAll('.tab-content'),
            inputs: {
                preset: document.getElementById('opt-preset'),
                fg: document.getElementById('opt-fg'),
                bg: document.getElementById('opt-bg'),
                accent: document.getElementById('opt-accent'),
                opacity: document.getElementById('opt-opacity'),
                glow: document.getElementById('opt-glow'),
                radius: document.getElementById('opt-radius'),
                bgEffect: document.getElementById('opt-bg-effect'),
                speed: document.getElementById('opt-effect-speed'),
                density: document.getElementById('opt-effect-density'),
                flicker: document.getElementById('opt-flicker'),
                sound: document.getElementById('opt-sound'),
                volume: document.getElementById('opt-volume'),
                font: document.getElementById('opt-font'),
                size: document.getElementById('opt-size'),
                spacing: document.getElementById('opt-spacing'),
                cursorStyle: document.getElementById('opt-cursor-style'),
                blink: document.getElementById('opt-blink')
            }
        };

        const PRESETS = {
            matrix: { fg: '#00ff00', bg: '#000000', accent: '#00ff00', bgEffect: 'matrix', sound: 'mech', fontFamily: "'Courier New', monospace", opacity: 0.95, glow: 15 },
            cyber: { fg: '#00ffff', bg: '#050510', accent: '#d600ff', bgEffect: 'stars', sound: 'scifi', fontFamily: "'Fira Code', monospace", opacity: 0.85, glow: 25 },
            bubblegum: { fg: '#ffffff', bg: '#ffaebb', accent: '#ffec40', bgEffect: 'bubbles', sound: 'bubble', fontFamily: "'Roboto Mono', monospace", opacity: 0.9, glow: 10 },
            ice: { fg: '#aaddff', bg: '#001a25', accent: '#00eaff', bgEffect: 'snow', sound: 'bubble', fontFamily: "'Consolas', monospace", opacity: 0.85, glow: 20 },
            midnight: { fg: '#a0a0b0', bg: '#0a0a0f', accent: '#506090', bgEffect: 'none', sound: 'typewriter', fontFamily: "'Fira Code', monospace", opacity: 0.98, glow: 5 },
            gold: { fg: '#eecfa1', bg: '#100a00', accent: '#ffbf00', bgEffect: 'none', sound: 'mech', fontFamily: "'Times New Roman', serif", opacity: 1, glow: 15 },
        };

        let settings = {
            preset: 'custom',
            foreground: '#00ff00', bg: '#000000', accent: '#00ff00', opacity: 1, glow: 20, radius: 12,
            bgEffect: 'none', effectSpeed: 50, effectDensity: 100, flicker: false,
            sound: 'none', volume: 0.5,
            fontFamily: "'Courier New', monospace", fontSize: 16, letterSpacing: 0, cursorStyle: 'block', cursorBlink: true
        };

        function hexToRgba(hex, alpha) {
            if (!hex) return `rgba(0,0,0,${alpha})`;
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex[1] + hex[2], 16); g = parseInt(hex[3] + hex[4], 16); b = parseInt(hex[5] + hex[6], 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        }

        function applySettings() {
            // Apply Visuals
            const container = document.getElementById('terminal-container');
            const bgRgba = hexToRgba(settings.bg, settings.opacity);

            container.style.background = bgRgba;
            container.style.borderColor = settings.accent;
            container.style.boxShadow = `0 0 ${settings.glow}px ${settings.accent}`;
            container.style.borderRadius = `${settings.radius}px`;

            const header = document.querySelector('.header');
            if (header) {
                header.style.color = settings.accent;
                header.style.borderBottomColor = settings.accent;
                header.style.background = hexToRgba(settings.bg, 0.95);
            }

            // Xterm Theme
            term.options.theme = {
                foreground: settings.foreground,
                cursor: settings.accent,
                selection: settings.accent,
                background: 'transparent'
            };

            term.options.fontFamily = settings.fontFamily;
            term.options.fontSize = parseInt(settings.fontSize);
            term.options.letterSpacing = parseFloat(settings.letterSpacing);
            term.options.cursorStyle = settings.cursorStyle;
            term.options.cursorBlink = settings.cursorBlink;

            // Effects
            effectMgr.setEffect(settings.bgEffect);
            effectMgr.setParams(settings.effectSpeed, settings.effectDensity);

            // Audio
            soundMgr.setType(settings.sound);
            soundMgr.setVolume(settings.volume);

            // Flicker Check
            if (settings.flicker) {
                container.style.animation = "flicker 0.15s infinite";
                if (!document.getElementById('flicker-style')) {
                    const s = document.createElement('style');
                    s.id = 'flicker-style';
                    s.innerHTML = `@keyframes flicker { 0% { opacity: 0.98; } 50% { opacity: 0.94; } 100% { opacity: 0.98; } }`;
                    document.head.appendChild(s);
                }
            } else {
                container.style.animation = "none";
            }

            // Sync UI Buttons to match
            ui.btn.style.background = settings.accent;
            ui.btn.style.boxShadow = `0 0 10px ${settings.accent}`;
            ui.modal.style.borderColor = settings.accent;
            ui.modal.style.color = settings.accent;

            fitTerm();
        }

        function loadSettings() {
            try {
                const s = localStorage.getItem('termSettingsV5');
                if (s) Object.assign(settings, JSON.parse(s));
            } catch (e) { }

            // Populate Inputs
            ui.inputs.fg.value = settings.foreground;
            ui.inputs.bg.value = settings.bg;
            ui.inputs.accent.value = settings.accent;
            ui.inputs.opacity.value = settings.opacity || 0.9;
            ui.inputs.glow.value = settings.glow;
            ui.inputs.radius.value = settings.radius;

            ui.inputs.bgEffect.value = settings.bgEffect;
            ui.inputs.speed.value = settings.effectSpeed;
            ui.inputs.density.value = settings.effectDensity;
            ui.inputs.flicker.checked = settings.flicker;

            ui.inputs.sound.value = settings.sound;
            ui.inputs.volume.value = settings.volume;

            ui.inputs.font.value = settings.fontFamily;
            ui.inputs.size.value = settings.fontSize;
            ui.inputs.spacing.value = settings.letterSpacing;
            ui.inputs.cursorStyle.value = settings.cursorStyle;
            ui.inputs.blink.checked = settings.cursorBlink;

            ui.inputs.preset.value = settings.preset;

            applySettings();
        }

        function saveSettings() {
            localStorage.setItem('termSettingsV5', JSON.stringify(settings));
        }

        // --- Event Listeners ---
        ui.btn.addEventListener('click', () => ui.modal.classList.toggle('active'));

        // Tab Switching
        ui.tabs.forEach(btn => btn.addEventListener('click', (e) => {
            ui.tabs.forEach(b => b.classList.remove('active'));
            ui.contents.forEach(c => c.classList.remove('active'));
            const target = e.currentTarget;
            target.classList.add('active');
            document.getElementById(target.dataset.tab).classList.add('active');
        }));

        const update = (key, val) => {
            settings[key] = val;
            if (settings.preset !== 'custom' && key !== 'preset') {
                settings.preset = 'custom';
                ui.inputs.preset.value = 'custom';
            }
            applySettings();
            saveSettings();
        };

        // Preset Handler
        ui.inputs.preset.addEventListener('change', e => {
            const p = PRESETS[e.target.value];
            if (p) {
                settings.preset = e.target.value;
                Object.assign(settings, p);
                // Update UI
                ui.inputs.fg.value = settings.foreground;
                ui.inputs.bg.value = settings.bg;
                ui.inputs.accent.value = settings.accent;
                ui.inputs.opacity.value = settings.opacity || 0.9;
                ui.inputs.bgEffect.value = settings.bgEffect;
                ui.inputs.sound.value = settings.sound;
                ui.inputs.font.value = settings.fontFamily;
                ui.inputs.glow.value = settings.glow || 20;

                applySettings();
                saveSettings();
            } else {
                update('preset', 'custom');
            }
        });

        // Attach Generic Inputs
        ui.inputs.fg.addEventListener('input', e => update('foreground', e.target.value));
        ui.inputs.bg.addEventListener('input', e => update('bg', e.target.value));
        ui.inputs.accent.addEventListener('input', e => update('accent', e.target.value));
        ui.inputs.opacity.addEventListener('input', e => update('opacity', e.target.value));
        ui.inputs.glow.addEventListener('input', e => update('glow', e.target.value));
        ui.inputs.radius.addEventListener('input', e => update('radius', e.target.value));

        ui.inputs.bgEffect.addEventListener('change', e => update('bgEffect', e.target.value));
        ui.inputs.speed.addEventListener('input', e => update('effectSpeed', e.target.value));
        ui.inputs.density.addEventListener('input', e => update('effectDensity', e.target.value));
        ui.inputs.flicker.addEventListener('change', e => update('flicker', e.target.checked));

        ui.inputs.sound.addEventListener('change', e => update('sound', e.target.value));
        ui.inputs.volume.addEventListener('input', e => update('volume', e.target.value));

        ui.inputs.font.addEventListener('change', e => update('fontFamily', e.target.value));
        ui.inputs.size.addEventListener('change', e => update('fontSize', e.target.value));
        ui.inputs.spacing.addEventListener('input', e => update('letterSpacing', e.target.value));
        ui.inputs.cursorStyle.addEventListener('change', e => update('cursorStyle', e.target.value));
        ui.inputs.blink.addEventListener('change', e => update('cursorBlink', e.target.checked));

        // Start
        effectMgr.start();
        loadSettings();

    </script>
</body>

</html>